# Kickstart file automatically generated by anaconda.
# kickstart to create the metanet VM.  
# the public key for mnauto must be added to sjdayday authorized keys on mirto1 
# to run this script; deleted to maintain security   

#version=DEVEL
cmdline
install
cdrom
lang en_US.UTF-8
keyboard us
network --onboot no --device eth0 --noipv4 --noipv6
rootpw meta4Rut
firewall --service=ssh
authconfig --enableshadow 
selinux --enforcing
timezone --utc America/Los_Angeles
bootloader --location=mbr --driveorder=sda,sdb
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
clearpart --all --initlabel
# added to avoid "Storage device warning" -- only use this for new VMs
zerombr yes

part /boot --fstype=ext4 --asprimary --size=256
part pv.008002 --grow --asprimary --size=200
part / --fstype=ext4 --size=1152

part pv.008017 --grow --asprimary --size=200 --ondisk=sdb
volgroup service --pesize=131072 pv.008017
#logvol /u --fstype=ext4 --name=servicelv --vgname=service --size=24448
logvol /u --fstype=ext4 --name=servicelv --vgname=service --size=51358

volgroup system --pesize=131072 pv.008002
logvol /home --fstype=ext4 --name=home --vgname=system --size=640
logvol /opt --fstype=ext4 --name=opt --vgname=system --size=640
logvol /opt/core --fstype=ext4 --name=opt_core --vgname=system --size=640
logvol swap --name=swap --vgname=system --size=1152
logvol /tmp --fstype=ext4 --name=tmp --vgname=system --size=1152
logvol /usr --fstype=ext4 --name=usr --vgname=system --size=1920
logvol /var --fstype=ext4 --name=var --vgname=system --size=1152
logvol /var/cache/yum --fstype=ext4 --name=var_cache_yum --vgname=system --size=1152

repo --name="CentOS"  --baseurl=file:///mnt/source --cost=100

%packages
@base
@console-internet
@core
@performance
@server-policy
gpm
sgpio
x86info
-vconfig
-setuptool
-zip
-rng-tools
-sos
-readahead
-hunspell-en
-tcsh
-abrt-cli
-ntpdate
-fprintd-pam
-dosfstools
-smartmontools
-unzip
-rfkill
-ntp
-rdate
-words
-abrt-addon-kerneloops
-abrt-addon-ccpp
-nano
-eject
-mtr
-pcmciautils
-hunspell
-abrt-addon-python
-b43-fwcutter
-powertop
-perf
-seekwatcher
-latencytop
-oprofile
-dstat
%end

%post --log=/root/ksmn_out.txt
/usr/bin/perl -pi.bak -e 's/#\s+\%wheel\s+ALL=\(ALL\)\s+ALL/%wheel  ALL=(ALL)  ALL/' /etc/sudoers
/usr/bin/perl -pi.bak -e 's/PermitRootLogin\s+yes/#PermitRootLogin yes\nPermitRootLogin no/' /etc/ssh/sshd_config 

/usr/sbin/useradd  -d /home/admin admin
/bin/echo meta4Min | /usr/bin/passwd --stdin admin
/usr/sbin/usermod -aG wheel admin 
/bin/mkdir /home/admin/.ssh
/sbin/restorecon -FRvv /home/admin/.ssh
# enable ssh access to admin for Steve Doubleday
/bin/echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDMMiEFFUE+Dpc8klYs6vecbB3QOmr0n4OzgiZ2y7AnsMi5I0ubnh6kyKV1mJz+zK1+6xvjnCYhgxvvswpMOhaZCYWZlhpoGoXz+gdIEFi5puwFFMIXBZHxJN3b5BJqOdhSLR4/WPO4Pklskb1EwZDvrFDaoSoTtdh0yheHFW3GpdKfTjMELyIgF3d0AT39Oko5xYluBMGNB4LDe/ouxkic4BJ3bTCEOWIHLHLsvzRhharGn2LvKnL4hmr31k89J/W8BCqjwtwssNm8dk2tb0ka7ZnY9aObNIHRYgGPG1YylLuYNJKrDXVDeyVT1UubNCw2Iy2qMyAv22S/bLg4zPJ1 stevedoubleday@gmail.com" > /home/admin/.ssh/authorized_keys

/bin/chmod 755 /home/admin
/bin/chmod 700 /home/admin/.ssh
/bin/chmod 600 /home/admin/.ssh/*
/bin/chown -R admin:admin /home/admin

/usr/sbin/groupadd metaphrs
/usr/sbin/useradd -g metaphrs -d /home/mnauto mnauto
/bin/echo meta4Met | /usr/bin/passwd --stdin mnauto
/bin/mkdir /home/mnauto/.ssh
/sbin/restorecon -FRvv /home/mnauto/.ssh
# enable ssh access to mnauto for Steve Doubleday
/bin/echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDMMiEFFUE+Dpc8klYs6vecbB3QOmr0n4OzgiZ2y7AnsMi5I0ubnh6kyKV1mJz+zK1+6xvjnCYhgxvvswpMOhaZCYWZlhpoGoXz+gdIEFi5puwFFMIXBZHxJN3b5BJqOdhSLR4/WPO4Pklskb1EwZDvrFDaoSoTtdh0yheHFW3GpdKfTjMELyIgF3d0AT39Oko5xYluBMGNB4LDe/ouxkic4BJ3bTCEOWIHLHLsvzRhharGn2LvKnL4hmr31k89J/W8BCqjwtwssNm8dk2tb0ka7ZnY9aObNIHRYgGPG1YylLuYNJKrDXVDeyVT1UubNCw2Iy2qMyAv22S/bLg4zPJ1 stevedoubleday@gmail.com" > /home/mnauto/.ssh/authorized_keys

# fix a private key for mnauto 
/bin/echo "-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEArBIYFIb+CuiOHvA3oSoc5f+jykiaqoEj6in6XY8SdWjOs/A4
52pofZ/6E0VPE9nTtvfVIyNjhKeB/LX5Db9m6oBtiEtvhKSRM0PqM1QTtOdBsjMA
8zUtHemG8Rlz+G5kkdkv8eGQytNm3k/eyMOxXaGQJUV/Kk4TAWez56EeYtbN5oi1
iiS7Qwdl125tZ8C6zGkVNx976ajkPwPL9SvMsseOrujOxynVYvn0bAg7ZDL5RDgF
A+anhICKoxYzc2mWZrWJtJ3Og+5xoXNpUXl2KmoAsQKU/tI0UuKHztIP/99MOuZY
tF/wuJTYnkvB9kZKm/SZ+oLaY5uo9tk9xH1ftwIBIwKCAQEAmGfML3BAGEpR/iU4
lg9bbKCYYrVVyjfd+0nAfsCMsSJQrgCnbeHnhTXsH7JqnI27hMzhWaMAX40Mu0IX
Gs4ZU1vOuov1DxVqqb/Pb0p32r4y36mEf6QgpXcRHrAk41p2VUtWWeULN02G/2tQ
S2t/1pZpupyj1QNSqXkbr+Z5/8QdOg9fMeQnhX9BFIa7SkXr6khkivyaybvXSWLS
KBgcrm7y0OQ0Qul+zyHhWVKSUEFvM2E/2KpGohHYTqqoVy4MFjDEL6HJwKSdNLTZ
IzXcrPezjhIUh/+JIU1hHDdNWlmoNeEaJ5hJDTa6Lq2KnI19CSbmFmuoBi4JL/Uf
b0YV8wKBgQDf77r0OuLFI+th4zrJ1mrbwrli3kgly9ws1yj5Bfm7PobjGVNP+R9d
OQhjLOPiuhy0S3EhJbDaYxehWanBuk2viizZZSZeo835I0E6h+Ir+ddewJjTu1ZJ
zIgYDGolsVb/GcXhd0cJAJWab1VpMQnfNmsucD3g5/v9zsoK8I7SOwKBgQDEtUCH
YUBeJUpG3QbgoJNQjY+C5TYCMccW67WTFIIzIuyyNiA7isDH9cMOsQDtRze/Kh9J
M+kqzYZP6FkviDp+YGIlZALWabkyW3aD9Gr+dYt8YIbj476BP7jADedprre4gTLV
lIW+iAvG0PibPcX3AF2AibrpMpT7n1VJJMB0tQKBgGzE5ccVSZL0MIAAp4abWHle
lI8bgiD8niRogZ2Gjz2wp+ql5qMv3Ai1TTd8NCxLxMyZq/ooP/ULjyJ8Af8CuATO
FciteQllgU0fwJjFqF6Aqm/Z49SOMTnJvnIUqJX3DP+QLOna2Vwk2vM9Y//knmUa
bpLmD209emVVz9lthzLpAoGBAJe/BeTHXYp0icGjMTDw5qva6w00eh7zMy7wWN8t
E/uP+Gw4YgIL8810cebDD1f1HGBFENISGkWXO7n8Yg65jDWaz16sPLQIaktrIOlz
aHsnejtgaA7i42sFRWD0yHYZEWJyS8lVUTs1v/Ek3QoLFQ8ASCFUTlwftMIb1BPa
hdZfAoGAa8FewungMefis2X0lidgXfLJfYxE/AnrQH6xTMANK5kEophMt3f85wo6
lmJsRjb43WZtG67QwjWMYjlQzmzcVdGY6xr8OKB/iceoNWya7OzJPi1Ew2UaBf//
dgag8ll3397lslIOsCuIHlCLheGcHmEe7QXGNzifvsEIxQN8NGY=
-----END RSA PRIVATE KEY-----" > /home/mnauto/.ssh/id_rsa

# corresponding public key for mnauto.  Must be added to 
# target host (mirto1) at ICSI to enable automatic login.  
/bin/echo "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEArBIYFIb+CuiOHvA3oSoc5f+jykiaqoEj6in6XY8SdWjOs/A452pofZ/6E0VPE9nTtvfVIyNjhKeB/LX5Db9m6oBtiEtvhKSRM0PqM1QTtOdBsjMA8zUtHemG8Rlz+G5kkdkv8eGQytNm3k/eyMOxXaGQJUV/Kk4TAWez56EeYtbN5oi1iiS7Qwdl125tZ8C6zGkVNx976ajkPwPL9SvMsseOrujOxynVYvn0bAg7ZDL5RDgFA+anhICKoxYzc2mWZrWJtJ3Og+5xoXNpUXl2KmoAsQKU/tI0UuKHztIP/99MOuZYtF/wuJTYnkvB9kZKm/SZ+oLaY5uo9tk9xH1ftw== mnauto@localhost.localdomain" > /home/mnauto/.ssh/id_rsa.pub

mirto1.icsi.berkeley.edu,192.150.186.162 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAIEAyP26ou/yJ9h9bwLsBGdcqbDAq1qnBxOWUfgPXerAIVJBQaMjYftLupWePrEiRE+Mg0PyaAbfAOY9/r+t/KY5prC68mSYkl8/JF7UWIjWdBK7ElXi5QqTsJie+Ob6Ve4nqFZh39rydlNRY8dA9mFArRW8DAGQYnrKPHZSW9+EAAs=" > /home/mnauto/.ssh/known_hosts


/bin/chmod 755 /home/mnauto
/bin/chmod 700 /home/mnauto/.ssh
/bin/chmod 600 /home/mnauto/.ssh/*
/bin/chown -R mnauto:metaphrs /home/mnauto

/bin/mkdir /u/metanet
/bin/mkdir /u/framenet
/bin/mkdir /u/metanet/tools64
/bin/mkdir /u/metanet/tools64/src
/bin/mkdir /u/metanet/tools
/bin/mkdir /u/metanet/tools/src
/bin/mkdir /u/metanet/data
/bin/chown -R mnauto:metaphrs /u

# needed for python build
/usr/bin/yum -y install glibc.i686
/usr/bin/yum -y groupinstall "Development Tools"
/usr/bin/yum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel
# needed for scipy
/usr/bin/yum -y install boost-devel libicu-devel
# needed for MySQL_python
/usr/bin/yum -y install  mysql-server mysql-devel
# needed for parsing
/usr/bin/yum -y install java-1.7.0-openjdk-devel.x86_64
# needed for python sparrow package dependency lxml: 
/usr/bin/yum -y install libxslt-devel.x86_64 libxml2-devel.x86_64
# useful for checking out possible packages for installation later
/usr/bin/yum -y install yum-plugin-downloadonly 

# bootstrap script for the rest of the mnauto build
#/usr/bin/printf "rsync -avzhe ssh sjdayday@mirto1.icsi.berkeley.edu:/n/banquet/dc/sjdayday/vm-metanet/bin /home/mnauto\ncd bin\n./build_and_test 2> build_err.txt > build_out.txt" > /home/mnauto/start_build
/usr/bin/printf "cd /home/mnauto\ngit clone ssh://sjdayday@mirto1.icsi.berkeley.edu/u/metanet/git/vm-metanet.git vmbin\ncd vmbin\n./build_and_test 2> build_err.txt > build_out.txt" > /home/mnauto/start_build
/bin/chmod 755 /home/mnauto/start_build
/bin/chown mnauto:metaphrs /home/mnauto/start_build

/bin/echo "ksmn: installing python 2.7"
/usr/bin/wget -O /tmp/Python-2.7.3.tar.bz2 --no-check-certificate  http://python.org/ftp/python/2.7.3/Python-2.7.3.tar.bz2 
cd /tmp
/bin/tar xf /tmp/Python-2.7.3.tar.bz2
cd /tmp/Python-2.7.3
# build python as a shared library; needed by lxml...change to local64
./configure --prefix=/usr/local64 --enable-shared
/usr/bin/make && make altinstall || /bin/echo "FAILED: python rc=$?"

# since python is shared, tell ld where it is 
/bin/echo "/usr/local64/lib" >> /etc/ld.so.conf 
/sbin/ldconfig -v 

/bin/echo "ksmn: installing distribute"
/usr/bin/wget -O /tmp/distribute-0.6.35.tar.gz --no-check-certificate http://pypi.python.org/packages/source/d/distribute/distribute-0.6.35.tar.gz   
cd /tmp
/bin/tar xf /tmp/distribute-0.6.35.tar.gz
cd /tmp/distribute-0.6.35
/usr/local64/bin/python2.7 setup.py install || /bin/echo "FAILED: distribute rc=$?"

/bin/echo "ksmn: installing virtualenv"
/usr/bin/wget -O /tmp/virtualenv-1.11.4.tar.gz --no-check-certificate https://pypi.python.org/packages/source/v/virtualenv/virtualenv-1.11.4.tar.gz
cd /tmp
/bin/tar xvfs /tmp/virtualenv-1.11.4.tar.gz
cd /tmp/virtualenv-1.11.4
/usr/local64/bin/python2.7  setup.py install || /bin/echo "FAILED: virtualenv rc=$?"

/bin/echo "ksmn: configuring virtualenv"
cd /tmp/virtualenv-1.11.4
/usr/local64/bin/python2.7 virtualenv.py /u/metanet/tools64/virtualenv/2.7.3
/bin/chown -R mnauto:metaphrs /u/metanet/tools64/virtualenv
/bin/chmod go+x /root

# run remainder of build after booting, from rc.local, once. 
/bin/cp /etc/rc.d/rc.local /etc/rc.d/rc.local.bak
/bin/echo "/root/start_mnauto_build &> /root/rc.local.log &" >> /etc/rc.d/rc.local
# init will need to use rsync, but disallowed by SELinux; disable for 1st boot
/usr/bin/perl -pi.bak -e 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config 
# one-time script: 
#   make ks log readable for archiving
#   turn SELINUX back to enforcing on next boot, after init rsyncs complete
#   kick off the mnauto build
/usr/bin/printf "/bin/chmod go+r -R /root\n/usr/bin/perl -pi.bak -e 's/SELINUX=disabled/SELINUX=enforcing/' /etc/selinux/config\ncd /etc/rc.d\nmv rc.local rc.local.first_exec\nmv rc.local.bak rc.local\nsu -l mnauto -c /home/mnauto/start_build &" > /root/start_mnauto_build
/bin/chmod 755 /root/start_mnauto_build
 
%end

reboot
